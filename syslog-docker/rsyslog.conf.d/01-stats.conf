# reference: https://www.rsyslog.com/monitoring-rsyslogs-impstats-with-kibana-and-spm/
module(load="mmnormalize" config.enabled=`echo $ENABLE_STATS`)
module(load="omelasticsearch" config.enabled=`echo $ENABLE_STATS`)

# pushes metrics to the stats ruleset every x seconds, in JSON
module(load="impstats"
    interval=`echo $STATS_INTERVAL`
    resetCounters="on"
    severity="7"
    format="json-elasticsearch"
    ruleset="stats"
    config.enabled=`echo $ENABLE_STATS`)

# defines how the final Elasticsearch JSON documents will look like
# contains the timestamp, the host name and all the fields from the JSON generated by impstats
template(name="rsyslog_stats" type="list") {
    constant(value="{")
    constant(value="\"@timestamp\":\"")    
    property(name="timereported" dateFormat="rfc3339")
    constant(value="\",\"host\":\"")      
    property(name="hostname")
    constant(value="\",")                 
    property(name="$!all-json" position.from="2")
}

# processes logs independently of other flows in rsyslog 
ruleset(name="stats" queue.type="linkedlist" queue.size="1000" config.enabled=`echo $ENABLE_STATS`) {
    # parses the JSONs generated by impstats
    action(
        name="parse_rsyslog_stats"
        type="mmnormalize"
        rule=["rule=:%data:json%"])

    # sends the final JSON documents
    action(
        name="push_rsyslog_stats"
        type="omelasticsearch"
        searchIndex="rsyslog-stats"
        server=`echo $ELASTIC_HOST`
        serverport=`echo $ELASTIC_PORT`
        template="rsyslog_stats"
        uid=`echo $ELASTIC_UID`
        pwd=`echo $ELASTIC_PWD`
        esVersion.major="8" # comment this line if bulkmode off
        bulkmode="on" # disable if rsyslog version below v.8.206
        action.resumeRetryCount="-1"
        action.resumeInterval="60")
}